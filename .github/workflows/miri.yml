name: Miri

on: [push, pull_request]

jobs:
  miri:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          profile: minimal
          # Miri requires nightly Rust
          toolchain: nightly
          override: true
          components: miri rust-src

      - name: Generate Cargo.lock
        uses: actions-rs/cargo@v1
        with:
          command: generate-lockfile

      - name: Clean
        run: cargo clean

      - name: Cache Dependencies
        uses: Swatinem/rust-cache@v2.8.2

      - name: Run Miri (bytes)
        # Run all of your tests inside of Miri interpreter
        run: cargo miri test -p ntex-bytes

      - name: Run Miri (ntex-service::cfg)
        # Run all of your tests inside of Miri interpreter
        run: cargo miri test -p ntex-service -- --test cfg::tests::
